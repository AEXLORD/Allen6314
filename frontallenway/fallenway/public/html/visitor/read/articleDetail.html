{% extends '../common/header.html' %}

{% block subIncludeFileBeforeBody %} 

<style type = "text/css">

.commentInputStyle {
    outline:none; 
    border:0px;
    border-bottom:1px solid #DDDDDD;
    width:100%;
}
</style>

{% endblock %}

{% block mainContent  %}
    <div style = "width:730px;margin:auto auto;">
        <input type = "hidden" value = "{{data.id}}" id= "articleId">
        
        <div id = "articleContent" style = "padding:30px;box-shadow: 1px 2px 2px 2px #DDDDDD">
            <div class = "text-right">
                <span style = "font-size:13px;">阅读量：{{data.readNum}} 次</span><br/>
                <span style = "font-size:13px;">发布时间：{{data.operationTime}} </span>
            </div>
            <br/>
            <div>
                <span style = "font-size:18px;">{{data.title}}</span>
            </div>
            <hr style = "background:none repeat scroll 0 0 #ddd;border:thin none;height:5px;margin-left:0px;width:15%"/>
            <div>
                {% autoescape false %}{{data.content}}{% endautoescape %}
            </div>
        </div>

        <div id = "publishComment" style = "margin-top:30px;">
            <h5>发表评论</h5>
            <div style = "width:24%;display:inline-block;float:left">
                <input type = "text" id = "username" class = "commentInputStyle" placeholder = "您的联系方式（邮箱）">
            </div>
            <div style = "width:1%;display:inline-block;float:left">:</div> 
            <div style = "width:26%;display:inline-block">
                <input type = "password" id = "password" class = "commentInputStyle" placeholder = "6位密文（您的专属回复帐号）">
            </div>
            <div style = "clear:both"></div>
            <div style = "width:90%;display:inline-block;float:left">
                <input type = "text" id = "content" class = "commentInputStyle" placeholder = "评论内容">
            </div>
            <div style = "width:7%;display:inline-block;float:right;margin-top:5px">
                <a href = "javascript:void(0)" onclick = "comment()">发表</a>
            </div>
            <div style = "clear:both"></div>
            <div id = "commentWarn"></div>
        </div>

        <div id = "displayComment">
            {% for comment in data.commentList %} 
            <div style = "margin-top:15px;padding:10px;box-shadow: 1px 2px 2px 2px #DDDDDD">
            
                {% if comment.replyTo == null || comment.replyTo == "" %}
                <span>{{comment.username}}：</span>
                {% else %}
                <span>{{comment.username}}&nbsp;&nbsp;回复&nbsp;&nbsp;{{comment.replyTo}} :</span>
                {% endif %}
                <br/>
                <span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{comment.content}}</span>
                <br/>
                <div class = "text-right">
                    {% if comment.replyTo == null || comment.replyTo == "" %}
                        <a href = "javascript:void(0)" onclick = "reply()">回复</a>
                    {% else %}
                        <a href = "javascript:void(0)" onclick = "reply()">回复</a> &nbsp;&nbsp; <a href = "">查看对话</a>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
{% endblock %}
    

{% block subIncludeFileAfterBody %}

<script type = "text/javascript">

function comment(){
    var articleId = $("#articleId").val();
    var username = $("#username").val();
    var password = $("#password").val();
    var content = $("#content").val();

    console.log("articleId = " + articleId);
    console.log("username = " + username);
    console.log("password = " + password);
    console.log("content = " + content);

    if(!validComment(username,password,content)){
        if(articleId == null){
            alert("发布评论失败：请刷新一下该页面");
            return ;
        }
        $("#commentWarn").empty();
        $("#commentWarn").append("<span style = \"color:red\">发表评论失败：非空 && （联系方式 <= 30字符） && （评论内容 <= 70字符） && （密码.length == 6）</span>");
        return;
    } 
    
    sendCommentRequest(articleId,username,password,content);
}

function validComment(username,password,content){
    if( (username == null) || (username.trim() == "") || (username.length > 30)){
        return false;
    }

    if( (password == null) || (password.length != 6)){
        return false;
    }

    if( (content == null) || (content.trim() == "") || content.trim() > 70){
        return false;
    }

    return true;
}

function sendCommentRequest(articleId,username,password,content){
     $.ajax({
        type: 'POST',
        url: 'comment',
        data: {
             "articleId": articleId,
             "username": username,
             "password": password,
             "content": content
        },
        success: function(){
            displayNewComment(username,content);
        },
        error: function(err){
            if(err.status == 1002){
                $("#commentWarn").empty();
                $("#commentWarn").append("<span style = \"color:red\">发表评论失败：非空 &&（联系方式 <= 30字符） && （评论内容 <= 70字符） && （密码.length == 6）</span>");
                return;
            }
            if(err.status == 2001){
                $("#commentWarn").empty();
                $("#commentWarn").append("<span style = \"color:red\">发表评论失败：该用户名的6位密码有误</span>");
                return;
            }
            $("#commentWarn").empty();
            $("#commentWarn").append("<span style = \"color:red\">后端服务报错，暂时无法发表评论</span>");
        }
    })
}

function displayNewComment(username,content){

    $("#username").val("");
    $("#password").val("");
    $("#content").val("");
    $("#commentWarn").empty();
    $("#commentWarn").append("<span style = \"color:blue\">发表评论成功</span>");

    $("#displayComment").append(
            "<div style = \"margin-top:15px;padding:10px;box-shadow: 1px 2px 2px 2px #DDDDDD\">" +
                "<span>"+ username +" :</span><br/>" +
                "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>"+content+"</span>" +
                "<br/>" +
                "<div class = \"text-right\">" +
                    "<a href = \"\">回复</a>" +
                "</div>" +
            "</div>"
        );
}

</script>
{% endblock %}

